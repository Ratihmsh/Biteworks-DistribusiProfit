<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biteworks - Dashboard Profit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.js"></script>
    
    <style>
        /* --- 1. RESET & LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            background-color: #eef2f6; color: #333; 
            height: 100vh; width: 100vw; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- 2. HEADER APP --- */
        header {
            background: linear-gradient(90deg, #001f8f 0%, #0033cc 100%);
            padding: 0 25px; height: 60px; 
            display: flex; align-items: center; justify-content: space-between;
            color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-box { background-color: rgba(255, 255, 255, 0.2); padding: 5px 12px; border-radius: 4px; font-weight: 800; letter-spacing: 1px; font-size: 1rem; }
        .app-title { font-size: 1.1rem; font-weight: 700; text-transform: uppercase; }

        /* --- 3. DASHBOARD GRID --- */
        .dashboard-container {
            flex: 1; display: grid; grid-template-columns: 500px 1fr; 
            gap: 15px; padding: 15px; height: calc(100vh - 60px); overflow: hidden;
        }

        /* --- 4. PANEL KIRI (INPUT) --- */
        .left-panel { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }

        .panel-card {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column;
        }

        .card-title {
            font-size: 0.85rem; font-weight: 700; color: #555; text-transform: uppercase;
            margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #f0f0f0;
        }

        /* Global Input Section */
        .global-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mini-stat { background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0; }
        .mini-label { font-size: 0.7rem; color: #64748b; font-weight: 600; display: block; }
        .mini-val { font-size: 0.9rem; font-weight: 800; color: #001f8f; }
        .input-global { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; color: #001f8f; }

        /* Upload Area Styled */
        .upload-compact {
            border: 2px dashed #cbd5e1; border-radius: 6px; padding: 15px; text-align: center;
            cursor: pointer; background: #f8fafc; transition: 0.2s; position: relative;
        }
        .upload-compact:hover { border-color: #001f8f; background: #eff6ff; }
        .upload-text { font-size: 0.85rem; font-weight: 600; color: #475569; }
        
        .upload-compact.has-file { border: 2px solid #22c55e; background: #f0fdf4; }
        .file-name-display { color: #15803d; font-weight: 700; word-break: break-all; }

        /* Daily Input Table */
        .daily-input-wrapper {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .daily-header { padding: 10px 15px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; font-weight: 700; font-size: 0.85rem; color: #333; }
        .daily-scroll-area { flex: 1; overflow-y: auto; }

        /* Validation Footer */
        .validation-footer {
            background: #1e293b; color: white; padding: 10px 15px; border-radius: 8px;
            flex-shrink: 0; font-size: 0.8rem;
        }
        .val-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .val-total { font-size: 0.9rem; font-weight: bold; border-top: 1px dashed #475569; padding-top: 5px; margin-top: 5px; }
        .status-badge { text-align: center; padding: 5px; margin-top: 8px; border-radius: 4px; font-weight: 800; font-size: 0.85rem; }
        .st-ok { background: #22c55e; color: white; }
        .st-err { background: #ef4444; color: white; }
        .st-warn { background: #f59e0b; color: white; }

        /* --- 5. PANEL KANAN (REKAP) --- */
        .right-panel {
            background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .rp-header {
            padding: 10px 15px; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center; background: #fff;
            gap: 15px; flex-shrink: 0;
        }
        .rp-info { flex: 1; }
        .rp-title { font-size: 1rem; font-weight: 800; color: #001f8f; margin: 0; }
        
        .rp-actions { display: flex; gap: 8px; }
        .btn-export {
            padding: 8px 15px; background-color: #166534; color: white; border: none; border-radius: 5px;
            font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.8rem;
            transition: 0.2s;
        }
        .btn-export:hover { background-color: #14532d; }
        .btn-export:disabled { background-color: #cbd5e1; cursor: not-allowed; }
        
        .btn-reset {
            padding: 8px 12px; background-color: #dc2626; color: white; border: none; border-radius: 5px;
            cursor: pointer; transition: 0.2s; font-size: 0.8rem;
        }
        .btn-reset:hover { background-color: #991b1b; }

        /* --- BARU: TOP SUMMARY CARDS --- */
        .top-cards-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;
            padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }
        .top-card {
            background: white; border-radius: 6px; padding: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
            position: relative; overflow: hidden;
        }
        .top-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        }
        /* Card Colors */
        .tc-blue { border-left: 4px solid #001f8f; } /* Mhs */
        .tc-green { border-left: 4px solid #166534; } /* Kas */
        .tc-orange { border-left: 4px solid #d97706; } /* Prodi */

        .tc-label { font-size: 0.7rem; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .tc-value { font-size: 1.1rem; font-weight: 800; color: #333; margin-top: 5px; }
        .tc-icon {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            font-size: 1.8rem; color: #f1f5f9; z-index: 0;
        }

        .rp-content { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; }


        /* --- 6. TABEL DESAIN --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { 
            background: #f1f5f9; color: #475569; font-weight: 700; text-transform: uppercase; 
            padding: 8px; text-align: left; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0;
        }
        td { padding: 6px 8px; border-bottom: 1px solid #e2e8f0; color: #333; vertical-align: middle; }
        
        .input-xs { width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; font-size: 0.8rem; text-align: right; }
        .input-xs:focus { outline: none; border-color: #001f8f; background: #eff6ff; }

        /* Employee Section Card */
        .emp-section { background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 15px; overflow: hidden; }
        .emp-head {
            background: #eff6ff; padding: 8px 15px; border-bottom: 1px solid #e2e8f0;
            display: flex; align-items: center; gap: 10px;
        }
        .emp-name { font-weight: 800; color: #001f8f; font-size: 0.9rem; text-transform: uppercase; }
        .emp-total { margin-left: auto; font-weight: 700; color: #166534; font-size: 0.9rem; }
        
        .text-right { text-align: right; }
        .text-bold { font-weight: 700; }
        .text-green { color: #166534; }
        .text-gray { color: #64748b; }
        .text-blue { color: #001f8f; font-weight: 700; }
        .row-empty { background: #fff7ed; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo-box">BITEWORKS</div>
            <div class="app-title">SISTEM REKAP & DISTRIBUSI PROFIT</div>
        </div>
        <div class="rp-actions">
            <button id="btnExport" class="btn-export" onclick="exportToExcel()" disabled>
                <i class="fa-solid fa-file-excel"></i> EXPORT
                </button>
                    <button class="btn-reset" onclick="resetAll()" title="Reset Data">
                        <i class="fa-solid fa-rotate-right"></i>
                </button>
        </div>
    </header>

    <div class="dashboard-container">
        
        <aside class="left-panel">
            
            <div class="panel-card">
                <div class="card-title">SETUP DATA</div>
                <div class="global-grid" style="margin-bottom: 10px;">
                    <div>
                        <label class="mini-label">TOTAL PROFIT GLOBAL</label>
                        <input type="number" id="globalProfitInput" class="input-global" placeholder="Rp 0">
                    </div>
                    <div class="mini-stat">
                        <span class="mini-label">TARGET PEGAWAI (40%)</span>
                        <div id="targetGlobalMhs" class="mini-val">Rp 0</div>
                    </div>
                </div>
                
                <div class="upload-compact" id="dropArea">
                    <div id="uploadPlaceholder">
                        <div class="upload-text">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 1.2rem; margin-bottom:5px; color:#001f8f;"></i><br>
                            Klik / Drag File Absensi (.xlsx)
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" hidden>
                </div>
            </div>

            <div class="daily-input-wrapper">
                <div class="daily-header">REKAPITULASI LABA HARIAN</div>
                <div class="daily-scroll-area">
                    <table id="tableDaily">
                        <thead>
                            <tr>
                                <th style="width: 20%;">TGL</th>
                                <th style="width: 15%;">JAM</th>
                                <th style="width: 35%;">INPUT LABA</th>
                                <th style="width: 30%; text-align:right;">MAHASISWA (40%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" style="text-align:center; padding: 20px; color:#999;">Belum ada data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="validation-footer">
                <div class="val-row">
                    <span>Total Input Laba:</span>
                    <span id="totalInputLaba">Rp 0</span>
                </div>
                <div class="val-row" style="color: #fbbf24;">
                    <span>Laba (Tanpa Absensi):</span>
                    <span id="summaryNoWorkProfit">Rp 0</span>
                </div>
                <div class="val-row" style="font-size:0.75rem; padding-left:10px; color:#94a3b8;">
                    ↳ Laba Tanpa Absensi (40%): <span id="summaryNoWorkAllocated">Rp 0</span>
                </div>
                <div class="val-row val-total">
                    <span>Total Terbagi (Real):</span>
                    <span id="summaryAllocatedMhs">Rp 0</span>
                </div>
                <div id="statusBox" class="status-badge st-ok">MENUNGGU DATA</div>
            </div>

        </aside>

        <main class="right-panel">
            <div class="rp-header">
                <div class="rp-info">
                    <h2 class="rp-title">ALOKASI LABA</h2>
                </div>
                <div class="rp-actions">
                    <!-- <button id="btnExport" class="btn-export" onclick="exportToExcel()" disabled>
                        <i class="fa-solid fa-file-excel"></i> EXPORT
                    </button>
                    <button class="btn-reset" onclick="resetAll()" title="Reset Data">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button> -->
                </div>
            </div>

            <div class="top-cards-grid">
                <div class="top-card tc-blue">
                    <i class="fa-solid fa-user-graduate tc-icon"></i>
                    <div class="tc-label">MAHASISWA (40%)</div>
                    <div class="tc-value" id="cardValMhs">Rp 0</div>
                </div>
                <div class="top-card tc-green">
                    <i class="fa-solid fa-vault tc-icon"></i>
                    <div class="tc-label">KAS (20%)</div>
                    <div class="tc-value" id="cardValKas">Rp 0</div>
                </div>
                <div class="top-card tc-orange">
                    <i class="fa-solid fa-building-columns tc-icon"></i>
                    <div class="tc-label">PRODI (40%)</div>
                    <div class="tc-value" id="cardValProdi">Rp 0</div>
                </div>
            </div>
            
            <div class="rp-content" id="employeeCardsContainer">
                <div style="text-align: center; color: #94a3b8; margin-top: 50px;">
                    <i class="fa-solid fa-users-viewfinder" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <p>Silakan upload file Excel untuk melihat rincian Mahasiswa.</p>
                </div>
            </div>
        </main>

    </div>

    <table id="tableHardfile" style="display: none;">
        <thead><tr><th>Nama</th><th>Tanggal</th><th>Shift</th><th>Jam</th><th>Insentif (Rp)</th></tr></thead>
        <tbody></tbody>
    </table>

    <script>
    moment.locale('id');

    let currentGlobalProfit = 0;
    let tableInputs = {}; 
    let dailySummarySeconds = {}; 
    let globalExcelData = [];
    let dateRange = { min: null, max: null };
    // Variabel untuk menyimpan nama file asli (default jika belum upload)
    let uploadedFileName = "Data_Absensi"; 

    const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
    
    // --- DOM REFERENCES ---
    const globalProfitInput = document.getElementById('globalProfitInput');
    const targetGlobalMhsDisplay = document.getElementById('targetGlobalMhs');
    
    // Cards Reference
    const cardValMhs = document.getElementById('cardValMhs');
    const cardValKas = document.getElementById('cardValKas');
    const cardValProdi = document.getElementById('cardValProdi');
    
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const btnExport = document.getElementById('btnExport');
    
    const tbodyHardfile = document.querySelector('#tableHardfile tbody');
    const tbodyDaily = document.querySelector('#tableDaily tbody');
    const employeeCardsContainer = document.getElementById('employeeCardsContainer');

    // --- 1. GLOBAL CALCULATION ---
    const calculateGlobal = (val) => {
        if (isNaN(val)) val = 0;
        currentGlobalProfit = val;
        
        const mhsPortion = val * 0.40;
        const kasPortion = val * 0.20;
        const prodiPortion = val * 0.40;

        // Update Panel Kiri
        targetGlobalMhsDisplay.innerText = formatRupiah(mhsPortion);

        // Update 3 Kartu Besar
        cardValMhs.innerText = formatRupiah(mhsPortion);
        cardValKas.innerText = formatRupiah(kasPortion);
        cardValProdi.innerText = formatRupiah(prodiPortion);

        validateTotals();
    }
    globalProfitInput.addEventListener('input', (e) => calculateGlobal(parseFloat(e.target.value)));

    // --- 2. UPLOAD LOGIC ---
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', function() { handleFile(this.files[0]); });
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.background = '#e0e7ff'; });
    dropArea.addEventListener('dragleave', () => { 
        if(!dropArea.classList.contains('has-file')) dropArea.style.background = '#f8fafc'; 
    });
    dropArea.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        if(!dropArea.classList.contains('has-file')) dropArea.style.background = '#f8fafc'; 
        handleFile(e.dataTransfer.files[0]); 
    });

    function handleFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {raw: false}); 

                if(jsonData.length > 0) {
                    // Simpan nama file asli tanpa ekstensi .xlsx
                    uploadedFileName = file.name.replace(/\.[^/.]+$/, "");

                    dropArea.classList.add('has-file');
                    dropArea.innerHTML = `
                        <i class="fa-solid fa-file-circle-check" style="font-size: 1.5rem; color: #166534; margin-bottom:5px;"></i>
                        <div class="file-name-display">${file.name}</div>
                    `;
                    processExcelData(jsonData);
                    btnExport.disabled = false;
                } else { alert("File kosong!"); }
            } catch (err) { console.error(err); alert("Gagal membaca file Excel. Pastikan format sesuai."); }
        };
        reader.readAsArrayBuffer(file);
    }

    function resetAll() {
        if(confirm("Reset semua data?")) { location.reload(); }
    }

    // --- 3. HELPER FUNCTIONS ---
    function timeStringToSeconds(val) {
        if (!val) return 0;
        if (typeof val === 'number' && val < 1) { return Math.round(val * 24 * 3600); }
        const str = val.toString();
        const parts = str.split(':');
        let seconds = 0;
        if (parts.length === 3) { seconds += parseInt(parts[0]) * 3600; seconds += parseInt(parts[1]) * 60; seconds += parseInt(parts[2]); } 
        else if (parts.length === 2) { seconds += parseInt(parts[0]) * 3600; seconds += parseInt(parts[1]) * 60; }
        else if (!isNaN(parseFloat(str))) { seconds += parseFloat(str) * 3600; } 
        return seconds;
    }

    function secondsToHMS(totalSeconds) {
        if (!totalSeconds) return "00:00:00";
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        const s = Math.floor(totalSeconds % 60);
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }
    
    function parseExcelDate(val) {
        if (!val) return null;
        if (typeof val === 'number') { return moment(new Date(Math.round((val - 25569) * 86400 * 1000))); }
        const formats = ['DD/MM/YYYY', 'D/M/YYYY', 'YYYY-MM-DD', 'DD-MM-YYYY', 'MM/DD/YYYY', 'MM/DD/YY'];
        const m = moment(val, formats, true);
        if(m.isValid()) return m;
        const d = new Date(val);
        if(!isNaN(d)) return moment(d);
        return null;
    }

    // --- 4. PROCESS EXCEL ---
    function processExcelData(data) {
        tbodyHardfile.innerHTML = '';
        tbodyDaily.innerHTML = '';
        employeeCardsContainer.innerHTML = ''; 
        dailySummarySeconds = {}; 
        tableInputs = {};
        globalExcelData = []; 
        dateRange = { min: null, max: null };
        
        let minDate = null;
        let maxDate = null;
        const processedData = [];

        data.forEach(row => {
            const rawDate = row['Tanggal'] || row['tanggal'] || row['Date'];
            const mDate = parseExcelDate(rawDate);
            if (mDate && mDate.isValid()) {
                if (!minDate || mDate.isBefore(minDate)) minDate = mDate.clone();
                if (!maxDate || mDate.isAfter(maxDate)) maxDate = mDate.clone();
                row._normalizedDateKey = mDate.format('YYYY-MM-DD');
                row._displayDate = mDate.format('DD/MM/YYYY');
                processedData.push(row);
            }
        });

        if (processedData.length === 0) { alert("Tidak ditemukan kolom 'Tanggal' yang valid!"); return; }

        processedData.sort((a, b) => a._normalizedDateKey.localeCompare(b._normalizedDateKey));
        globalExcelData = processedData;
        dateRange.min = minDate;
        dateRange.max = maxDate;

        processedData.forEach((row) => {
            const nama = row['Nama'] || row['nama'] || '-';
            const dateKey = row._normalizedDateKey;
            const shift = row['Shift'] || row['shift'] || '-';
            const rawTime = row['Total Jam Kerja'] || row['total jam kerja'] || row['Durasi'] || "00:00:00";
            const seconds = timeStringToSeconds(rawTime);

            row['Total Jam Kerja'] = secondsToHMS(seconds); 

            const tr = document.createElement('tr');
            tr.setAttribute('data-date-key', dateKey);
            tr.setAttribute('data-seconds', seconds);
            tr.innerHTML = `<td>${nama}</td><td>${row._displayDate}</td><td>${shift}</td><td>${row['Total Jam Kerja']}</td><td class="incentive-cell">Rp 0</td>`;
            tbodyHardfile.appendChild(tr);

            dailySummarySeconds[dateKey] = (dailySummarySeconds[dateKey] || 0) + seconds;
        });

        if (minDate && maxDate) {
            let currentDate = minDate.clone();
            const end = maxDate.clone();

            while (currentDate.isSameOrBefore(end)) {
                const dateKey = currentDate.format('YYYY-MM-DD');
                const displayDate = currentDate.format('DD/MM/YYYY');
                const totalSeconds = dailySummarySeconds[dateKey] || 0;
                const formattedTotal = secondsToHMS(totalSeconds);
                const infoId = `info-${dateKey}`; 
                
                const tr = document.createElement('tr');
                let totalCellHtml = `<td style="font-weight:bold;">${formattedTotal}</td>`;
                let inputHtml = `<input type="number" class="input-xs" placeholder="Rp. (0)" oninput="handleDailyInput('${dateKey}', this.value)">`;
                let portionHtml = `<td class="text-right text-blue" id="${infoId}">Rp 0</td>`;

                if (totalSeconds === 0) {
                    tr.className = "row-empty";
                    totalCellHtml = `<td style="font-style:italic; font-size:0.75rem; color:#d97706;">-</td>`;
                }

                tr.innerHTML = `<td>${displayDate}</td>${totalCellHtml}<td>${inputHtml}</td>${portionHtml}`;
                tbodyDaily.appendChild(tr);
                currentDate.add(1, 'days');
            }
        }
        updateEmployeeCards(); 
        validateTotals(); 
    }

    // --- 5. INPUT HANDLING ---
    window.handleDailyInput = function(dateKey, val) {
        tableInputs[dateKey] = parseFloat(val) || 0;
        const infoSpan = document.getElementById(`info-${dateKey}`);
        const portionMahasiswa = tableInputs[dateKey] * 0.40;
        if(infoSpan) infoSpan.innerText = formatRupiah(portionMahasiswa);

        const totalDailySeconds = dailySummarySeconds[dateKey] || 0;
        const detailRows = document.querySelectorAll(`#tableHardfile tr[data-date-key="${dateKey}"]`);
        
        if (detailRows.length > 0 && totalDailySeconds > 0) {
            detailRows.forEach(row => {
                const userSeconds = parseFloat(row.getAttribute('data-seconds'));
                const share = (userSeconds / totalDailySeconds) * portionMahasiswa;
                row.querySelector('.incentive-cell').innerText = formatRupiah(share);
            });
        }

        updateEmployeeCards(); 
        validateTotals();
    };

    // --- 6. RENDER CARDS ---
    function updateEmployeeCards() {
        const employees = {};
        globalExcelData.forEach(row => {
            const name = row['Nama'] || row['nama'] || 'Tanpa Nama';
            if (!employees[name]) employees[name] = [];
            employees[name].push(row);
        });

        employeeCardsContainer.innerHTML = ''; 
        
        Object.keys(employees).sort().forEach(name => {
            const empData = employees[name];
            let totalGaji = 0;

            const card = document.createElement('div');
            card.className = 'emp-section';

            let tableHtml = `
                <div class="emp-head">
                    <i class="fa-solid fa-user-circle" style="color:#001f8f;"></i>
                    <span class="emp-name">${name}</span>
                    <span class="emp-total" id="total-${name.replace(/\s/g, '')}">TOTAL: Rp 0</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:20%">TGL</th>
                            <th style="width:15%">SHIFT</th>
                            <th style="width:15%">JAM KERJA </th>
                            <th style="width:20%">LAMA BUKA</th>
                            <th style="width:30%; text-align:right;">GAJI DITERIMA</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            empData.sort((a, b) => a._normalizedDateKey.localeCompare(b._normalizedDateKey));
            
            empData.forEach(row => {
                const dateKey = row._normalizedDateKey;
                const totalDailySeconds = dailySummarySeconds[dateKey] || 0;
                const totalDailyProfit = tableInputs[dateKey] || 0;
                const portionMahasiswa = totalDailyProfit * 0.40;
                
                const userSeconds = timeStringToSeconds(row['Total Jam Kerja']);
                let gajiHarian = 0;

                if (totalDailySeconds > 0) {
                    gajiHarian = (userSeconds / totalDailySeconds) * portionMahasiswa;
                }
                totalGaji += gajiHarian;

                tableHtml += `
                    <tr>
                        <td>${row._displayDate}</td>
                        <td>${row['Shift'] || '-'}</td>
                        <td>${row['Total Jam Kerja']}</td>
                        <td class="text-gray">${secondsToHMS(totalDailySeconds)}</td>
                        <td class="text-right text-bold text-green">${formatRupiah(gajiHarian)}</td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            card.innerHTML = tableHtml;
            card.querySelector('.emp-total').innerText = "TOTAL: " + formatRupiah(totalGaji);
            employeeCardsContainer.appendChild(card);
        });
    }

    // --- 7. VALIDATION ---
    function validateTotals() {
        let totalInputRaw = 0;
        let totalNoWorkProfit = 0; 
        for (const [key, val] of Object.entries(tableInputs)) {
            totalInputRaw += val;
            if (!dailySummarySeconds[key] || dailySummarySeconds[key] === 0) totalNoWorkProfit += val;
        }
        
        let totalAllocatedMhs = totalInputRaw * 0.40;
        let targetGlobalMhs = currentGlobalProfit * 0.40;
        let difference = totalAllocatedMhs - targetGlobalMhs;

        document.getElementById('totalInputLaba').innerText = formatRupiah(totalInputRaw);
        document.getElementById('summaryAllocatedMhs').innerText = formatRupiah(totalAllocatedMhs);
        document.getElementById('summaryNoWorkProfit').innerText = formatRupiah(totalNoWorkProfit);
        document.getElementById('summaryNoWorkAllocated').innerText = formatRupiah(totalNoWorkProfit * 0.40);

        const statusBox = document.getElementById('statusBox');
        statusBox.className = 'status-badge'; 

        if (currentGlobalProfit === 0 && totalInputRaw === 0) {
            statusBox.innerText = "MENUNGGU INPUT DATA";
            statusBox.classList.add('st-ok');
            return;
        }

        if (Math.abs(difference) < 100) {
            statusBox.innerText = "BALANCE (SESUAI) ✅";
            statusBox.classList.add('st-ok');
        } else if (difference < 0) {
            statusBox.innerText = `KURANG (-) ${formatRupiah(Math.abs(difference))} ❌`;
            statusBox.classList.add('st-err'); 
        } else {
            statusBox.innerText = `LEBIH (+) ${formatRupiah(difference)} ⚠️`;
            statusBox.classList.add('st-warn'); 
        }
    }

    // --- 8. EXPORT EXCEL (4 SHEETS) ---
    function exportToExcel() {
        if (!dateRange.min || !dateRange.max) { alert("Tidak ada data!"); return; }

        const wb = XLSX.utils.book_new();

        // --- SHEET 1: Ringkasan ---
        let totalInputRaw = 0;
        let totalNoWorkProfit = 0;
        for (const [key, val] of Object.entries(tableInputs)) {
            totalInputRaw += val;
            if (!dailySummarySeconds[key] || dailySummarySeconds[key] === 0) totalNoWorkProfit += val;
        }
        let targetGlobalMhs = currentGlobalProfit * 0.40;
        let totalAllocatedMhs = totalInputRaw * 0.40;
        let difference = totalAllocatedMhs - targetGlobalMhs;
        let status = Math.abs(difference) < 100 ? "BALANCE" : (difference < 0 ? "KURANG" : "LEBIH");

        const summaryData = [
            ["LAPORAN DISTRIBUSI PROFIT"], [""],
            ["Target Profit Global", currentGlobalProfit],
            ["Target Laba Mhs (40%)", targetGlobalMhs],
            ["Target Kas (20%)", currentGlobalProfit * 0.20],
            ["Target Prodi (40%)", currentGlobalProfit * 0.40],
            [""],
            ["RINGKASAN REALISASI"],
            ["Total Input Laba", totalInputRaw],
            ["Total Dana Terbagi ke Mahasiswa ", totalAllocatedMhs],
            ["Total Laba Tanpa Absensi", totalNoWorkProfit],
            ["Total Laba Tanpa Absensi (40%)", totalNoWorkProfit * 0.40],
            [""],
            ["STATUS", status],
            ["Selisih", difference]
        ];
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, wsSummary, "Ringkasan");

        // --- SHEET 2: Laporan Harian ---
        const sheet1Data = [["TANGGAL", "TOTAL JAM BUKA", "INPUT LABA", "JATAH MAHASISWA (40%)", "STATUS"]];
        let currentDate = dateRange.min.clone();
        const end = dateRange.max.clone();
        while (currentDate.isSameOrBefore(end)) {
            const dateKey = currentDate.format('YYYY-MM-DD');
            const totalSec = dailySummarySeconds[dateKey] || 0;
            const profit = tableInputs[dateKey] || 0;
            sheet1Data.push([
                currentDate.format('DD/MM/YYYY'), secondsToHMS(totalSec), profit, profit * 0.40, (totalSec === 0 ? "TIDAK ADA ABSENSI" : "BUKA")
            ]);
            currentDate.add(1, 'days');
        }
        const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
        XLSX.utils.book_append_sheet(wb, ws1, "Laporan Harian");

        // --- SHEET 3: Rincian Mahasiswa ---
        const sheet2Data = [["NAMA", "TANGGAL", "SHIFT", "JAM KERJA", "LABA HARIAN", "INSENTIF"]];
        
        // Variabel untuk menampung total per orang (Untuk Sheet 4)
        const totalGajiPerOrang = {};

        globalExcelData.forEach(row => {
            const dateKey = row._normalizedDateKey;
            const totalDailySeconds = dailySummarySeconds[dateKey] || 0;
            const profit = tableInputs[dateKey] || 0;
            const portionMhs = profit * 0.40;
            let incentive = 0;
            const userSeconds = timeStringToSeconds(row['Total Jam Kerja']);
            if(totalDailySeconds > 0) incentive = (userSeconds / totalDailySeconds) * portionMhs;
            
            // Masukkan ke Sheet 3
            sheet2Data.push([
                row['Nama'], row._displayDate, row['Shift'], row['Total Jam Kerja'], profit, incentive
            ]);

            // Hitung akumulasi untuk Sheet 4
            const nama = row['Nama'] || "Tanpa Nama";
            if(!totalGajiPerOrang[nama]) totalGajiPerOrang[nama] = 0;
            totalGajiPerOrang[nama] += incentive;
        });
        const ws2 = XLSX.utils.aoa_to_sheet(sheet2Data);
        XLSX.utils.book_append_sheet(wb, ws2, "Rincian Mahasiswa");

        // --- SHEET 4: Total Gaji Mahasiswa (BARU) ---
        const sheet4Data = [["NAMA MAHASISWA", "TOTAL GAJI DITERIMA"]];
        
        // Urutkan nama secara abjad
        Object.keys(totalGajiPerOrang).sort().forEach(nama => {
            sheet4Data.push([nama, totalGajiPerOrang[nama]]);
        });

        const ws4 = XLSX.utils.aoa_to_sheet(sheet4Data);
        XLSX.utils.book_append_sheet(wb, ws4, "Total Gaji Mahasiswa");

        // --- EXPORT FILE ---
        const finalName = "HASIL_REKAP_" + uploadedFileName + ".xlsx";
        XLSX.writeFile(wb, finalName);
    }
    </script>
</body>
</html>