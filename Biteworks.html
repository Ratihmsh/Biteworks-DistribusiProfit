<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROFIT DISTRIBUTION SYSTEM BITEWORKS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0f172a;
            --accent: #2563eb;
            --success: #166534;
            --warning: #ca8a04;
            --danger: #b91c1c;
            --bg-table-head: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Mencegah scroll halaman utama */
        }

        /* --- UTILITY SCROLLBAR --- */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* --- LAYOUT GRID --- */
        .main-dashboard {
            flex: 1;
            display: grid;
            grid-template-columns: 45% 55%; /* Kiri: Jurnal (Lebih besar dikit), Kanan: Log & Result */
            gap: 1rem;
            padding: 1rem;
            min-height: 0; /* Penting untuk nested scroll */
        }

        .panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title { font-weight: 700; color: var(--primary); font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
        .panel-content { flex: 1; overflow-y: auto; position: relative; }

        /* --- TABLE STYLES --- */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { 
            background: var(--bg-table-head); 
            color: #475569; 
            font-weight: 600; 
            padding: 0.6rem 0.5rem; 
            text-align: left; 
            position: sticky; 
            top: 0; 
            z-index: 10;
            border-bottom: 2px solid #e2e8f0;
        }
        td { padding: 0.5rem; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }
        tr:hover td { background-color: #f8fafc; }
        
        .input-currency {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-align: right;
        }
        .input-currency:focus { border-color: var(--accent); outline: none; ring: 2px solid #bfdbfe; }

        /* --- CARDS & KPI --- */
        .kpi-wrapper {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .kpi-card {
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid #e2e8f0;
        }
        .kpi-blue { background: #eff6ff; border-color: #bfdbfe; }
        .kpi-green { background: #f0fdf4; border-color: #bbf7d0; }
        .kpi-amber { background: #fffbeb; border-color: #fde68a; }
        .kpi-slate { background: #f8fafc; border-color: #e2e8f0; }

        .kpi-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 2px; }
        .kpi-value { font-size: 1.1rem; font-weight: 700; color: #0f172a; }

        /* --- MULTI SELECT DROPDOWN (Custom) --- */
        .ms-wrapper { position: relative; width: 100%; }
        .ms-display {
            padding: 6px 10px;
            background: #fff;
            border: 1px dashed #cbd5e1;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #64748b;
            text-align: center;
        }
        .ms-display:hover { border-color: var(--accent); color: var(--accent); }
        .ms-display.active { background: #eff6ff; border: 1px solid #60a5fa; color: #1e40af; font-weight: 600; }
        
        .ms-dropdown {
            display: none;
            position: fixed; /* Fixed agar tidak terpotong overflow tabel */
            background: white;
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            width: 250px;
            z-index: 9999;
            padding: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        .ms-dropdown.show { display: block; }
        .ms-option {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .ms-option:hover { background: #f1f5f9; }
        .ms-option input { margin-right: 8px; accent-color: var(--accent); }
        .ms-summary { font-size: 0.7rem; color: #166534; margin-top: 2px; text-align: right; }

        /* --- EMPLOYEE CARD COMPONENT --- */
        .emp-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; padding: 0.75rem; }
        .emp-section {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            font-size: 0.8rem;
        }
        .emp-head {
            background: #f8fafc;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }
        .emp-name { color: #334155; display: flex; align-items: center; gap: 6px; }
        .emp-total { color: var(--success); background: #dcfce7; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #86efac; }
        
        /* --- STATUS BADGE --- */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            width: 100%;
        }
        .st-ok { background: #dcfce7; color: #14532d; border: 1px solid #86efac; }
        .st-warn { background: #fef9c3; color: #713f12; border: 1px solid #fde047; }
        .st-err { background: #fee2e2; color: #7f1d1d; border: 1px solid #fca5a5; }

        /* --- FILE UPLOAD --- */
        .file-drop {
            border: 2px dashed #94a3b8;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            color: #64748b;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .file-drop:hover { background: #e2e8f0; border-color: #64748b; }
        .file-drop.has-file { border-style: solid; border-color: var(--success); background: #f0fdf4; color: var(--success); }

    </style>
</head>
<body>

    <nav class="bg-slate-900 text-white px-4 py-3 flex justify-between items-center shadow-md z-20">
        <div class="flex items-center gap-4">
            <div class="font-black text-2xl tracking-widest text-blue-400">BITEWORKS</div>
            <div>
                <h1 class="font-bold text-sm tracking-wide text-white">SISTEM DISTRIBUSI PROFIT & INTENSIF SDM</h1>
                <!-- <p class="text-xs text-slate-400">Ver. 2.6 (Accounting Edition)</p> -->
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="resetAll()" class="px-3 py-1.5 text-xs font-medium text-slate-300 hover:text-white border border-slate-700 rounded transition">
                <i class="fa-solid fa-rotate-left mr-1"></i> Reset
            </button>
            <button id="btnExport" onclick="exportToExcel()" disabled class="px-4 py-1.5 text-xs font-bold bg-emerald-600 hover:bg-emerald-500 rounded text-white shadow transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa-solid fa-file-excel mr-2"></i> Export Laporan (.xlsx)
            </button>
        </div>
    </nav>

    <div class="kpi-wrapper">
        <div class="kpi-card kpi-slate relative">
            <label class="kpi-label"><i class="fa-solid fa-coins mr-1"></i> Total Laba Bersih (Net Profit)</label>
            <input type="number" id="globalProfitInput" class="w-full bg-white border border-slate-300 rounded px-2 py-1 text-lg font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none mt-1" placeholder="0">
            <div class="absolute top-2 right-2 text-xs text-slate-400">Manual Input</div>
        </div>

        <div class="kpi-card kpi-green">
            <label class="kpi-label">Alokasi SDM (40%)</label>
            <div id="cardValMhs" class="kpi-value text-green-700">Rp 0</div>
        </div>
        <div class="kpi-card kpi-amber">
            <label class="kpi-label">Kas Cadangan (20%)</label>
            <div id="cardValKas" class="kpi-value text-yellow-700">Rp 0</div>
        </div>
        <div class="kpi-card kpi-blue">
            <label class="kpi-label">Setoran Prodi (40%)</label>
            <div id="cardValProdi" class="kpi-value text-blue-700">Rp 0</div>
        </div>
    </div>

    <div class="main-dashboard">
        
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title text-blue-700">
                    <i class="fa-solid fa-book-open"></i> JURNAL PENDAPATAN HARIAN
                </div>
                <div class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded">
                    Total Revenue: <span id="totalInputLaba" class="text-slate-800 font-bold">Rp 0</span>
                </div>
            </div>
            <div class="panel-content custom-scroll bg-white">
                <table id="tableDaily">
                    <thead>
                        <tr>
                            <th style="width: 15%;">TANGGAL</th>
                            <th style="width: 20%;">JAM OPS</th>
                            <th style="width: 25%;">REVENUE / OMZET</th>
                            <th style="width: 40%;">ALOKASI SDM & DISTRIBUSI</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" class="text-center py-10 text-slate-400 italic">Belum ada data. Silakan upload file Excel.</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="p-3 bg-slate-50 border-t border-slate-200">
                <div id="statusBox" class="status-badge st-ok">MENUNGGU DATA</div>
            </div>
        </div>

        <div class="flex flex-col gap-4" style="min-height: 0;">
            
            <div class="panel" style="flex: 1;">
                <div class="panel-header">
                    <div class="panel-title"><i class="fa-solid fa-file-import"></i> LOG ABSENSI (REFERENSI)</div>
                    <div id="dropArea" class="file-drop" style="width: 180px; padding: 2px 8px; height: auto; flex-direction: row; gap: 5px;">
                        <i class="fa-solid fa-cloud-arrow-up"></i> <span>Upload Excel</span>
                    </div>
                    <input type="file" id="fileInput" hidden accept=".xlsx, .xls">
                </div>
                <div class="panel-content custom-scroll">
                    <table id="tableHardfile">
                        <thead>
                            <tr>
                                <th>NAMA</th>
                                <th>TGL</th>
                                <th>SHIFT</th>
                                <th>JAM KERJA</th>
                                <th class="text-right">INSENTIF</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="panel" style="flex: 1.5;">
                <div class="panel-header bg-green-50">
                    <div class="panel-title text-green-800"><i class="fa-solid fa-users-viewfinder"></i> DISTRIBUSI PER PEGAWAI</div>
                    <div class="text-xs text-green-600 font-bold" id="summaryAllocatedMhs">Rp 0</div>
                </div>
                <div class="panel-content custom-scroll bg-slate-50" id="employeeCardsContainer">
                    <div class="flex flex-col items-center justify-center h-full text-slate-400">
                        <i class="fa-solid fa-chart-pie text-4xl mb-2"></i>
                        <span class="text-sm">Hasil perhitungan akan muncul di sini</span>
                    </div>
                </div>
                
                <div class="hidden">
                    <span id="summaryNoWorkProfit">0</span>
                    <span id="summaryNoWorkAllocated">0</span>
                </div>
            </div>

        </div>
    </div>

    <script>
        moment.locale('id');

        // --- STATE VARIABLES ---
        let currentGlobalProfit = 0;
        let tableInputs = {}; 
        let dailySummarySeconds = {}; 
        let globalExcelData = [];
        let uniqueEmployeeList = []; 
        let specialAllocations = {}; 
        let dateRange = { min: null, max: null };
        let uploadedFileName = "Data_Absensi"; 
        
        let userTotalSeconds = {}; 
        let grandTotalSeconds = 0; 

        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        
        // --- DOM REFERENCES ---
        const globalProfitInput = document.getElementById('globalProfitInput');
        const cardValMhs = document.getElementById('cardValMhs');
        const cardValKas = document.getElementById('cardValKas');
        const cardValProdi = document.getElementById('cardValProdi');
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const btnExport = document.getElementById('btnExport');
        const tbodyHardfile = document.querySelector('#tableHardfile tbody');
        const tbodyDaily = document.querySelector('#tableDaily tbody');
        const employeeCardsContainer = document.getElementById('employeeCardsContainer');

        // --- 1. UPLOAD LOGIC ---
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', function() { handleFile(this.files[0]); });
        
        ['dragover', 'dragleave', 'drop'].forEach(evt => {
            dropArea.addEventListener(evt, (e) => {
                e.preventDefault();
                if(evt === 'dragover') dropArea.style.borderColor = '#2563eb';
                if(evt === 'dragleave' || evt === 'drop') dropArea.style.borderColor = '#94a3b8';
            });
        });
        
        dropArea.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false}); 

                    if(jsonData.length > 0) {
                        uploadedFileName = file.name.replace(/\.[^/.]+$/, "");
                        dropArea.classList.add('has-file');
                        dropArea.innerHTML = `<i class="fa-solid fa-check-circle text-green-600"></i> <span class="font-bold text-green-700 truncate w-24">${file.name}</span>`;
                        processExcelData(jsonData);
                        btnExport.disabled = false;
                    } else { alert("File kosong!"); }
                } catch (err) { console.error(err); alert("Gagal membaca file Excel."); }
            };
            reader.readAsArrayBuffer(file);
        }

        function resetAll() { if(confirm("Reset semua data?")) location.reload(); }

        // --- 2. HELPER FUNCTIONS ---
        function timeStringToSeconds(val) {
            if (!val) return 0;
            if (typeof val === 'number' && val < 1) { return Math.round(val * 24 * 3600); }
            const str = val.toString();
            const parts = str.split(':');
            let seconds = 0;
            if (parts.length === 3) { seconds += parseInt(parts[0]) * 3600; seconds += parseInt(parts[1]) * 60; seconds += parseInt(parts[2]); } 
            else if (parts.length === 2) { seconds += parseInt(parts[0]) * 3600; seconds += parseInt(parts[1]) * 60; }
            else if (!isNaN(parseFloat(str))) { seconds += parseFloat(str) * 3600; } 
            return seconds;
        }

        function secondsToHMS(totalSeconds) {
            if (!totalSeconds) return "00:00:00";
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = Math.floor(totalSeconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        function parseExcelDate(val) {
            if (!val) return null;
            if (typeof val === 'number') { return moment(new Date(Math.round((val - 25569) * 86400 * 1000))); }
            const m = moment(val, ['DD/MM/YYYY', 'YYYY-MM-DD'], true);
            return m.isValid() ? m : moment(new Date(val));
        }

        // --- 3. PROCESS EXCEL ---
        function processExcelData(data) {
            tbodyHardfile.innerHTML = '';
            tbodyDaily.innerHTML = '';
            employeeCardsContainer.innerHTML = ''; 
            dailySummarySeconds = {}; 
            tableInputs = {};
            specialAllocations = {}; 
            globalExcelData = []; 
            uniqueEmployeeList = [];
            userTotalSeconds = {};
            grandTotalSeconds = 0;
            dateRange = { min: null, max: null };
            
            let minDate = null;
            let maxDate = null;
            const tempNames = new Set();

            data.forEach(row => {
                const rawDate = row['Tanggal'] || row['tanggal'] || row['Date'];
                const mDate = parseExcelDate(rawDate);
                if (mDate && mDate.isValid()) {
                    if (!minDate || mDate.isBefore(minDate)) minDate = mDate.clone();
                    if (!maxDate || mDate.isAfter(maxDate)) maxDate = mDate.clone();
                    row._normalizedDateKey = mDate.format('YYYY-MM-DD');
                    row._displayDate = mDate.format('DD/MM/YYYY');
                    
                    const nama = row['Nama'] || row['nama'];
                    if(nama) tempNames.add(nama);

                    globalExcelData.push(row);
                }
            });

            if (globalExcelData.length === 0) { alert("Data tanggal tidak valid!"); return; }

            uniqueEmployeeList = Array.from(tempNames).sort();
            globalExcelData.sort((a, b) => a._normalizedDateKey.localeCompare(b._normalizedDateKey));
            dateRange.min = minDate;
            dateRange.max = maxDate;

            uniqueEmployeeList.forEach(n => userTotalSeconds[n] = 0);

            globalExcelData.forEach((row) => {
                const nama = row['Nama'] || row['nama'] || '-';
                const dateKey = row._normalizedDateKey;
                const shift = row['Shift'] || row['shift'] || '-';
                const rawTime = row['Total Jam Kerja'] || row['total jam kerja'] || "00:00:00";
                const seconds = timeStringToSeconds(rawTime);

                row['Total Jam Kerja'] = secondsToHMS(seconds); 

                if (nama !== '-') {
                    userTotalSeconds[nama] = (userTotalSeconds[nama] || 0) + seconds;
                    grandTotalSeconds += seconds;
                }

                const tr = document.createElement('tr');
                tr.setAttribute('data-date-key', dateKey);
                tr.setAttribute('data-seconds', seconds);
                tr.innerHTML = `<td>${nama}</td><td>${row._displayDate}</td><td>${shift}</td><td>${row['Total Jam Kerja']}</td><td class="incentive-cell text-right font-medium text-slate-500">Rp 0</td>`;
                tbodyHardfile.appendChild(tr);

                dailySummarySeconds[dateKey] = (dailySummarySeconds[dateKey] || 0) + seconds;
            });

            if (minDate && maxDate) {
                let currentDate = minDate.clone();
                const end = maxDate.clone();

                while (currentDate.isSameOrBefore(end)) {
                    const dateKey = currentDate.format('YYYY-MM-DD');
                    const displayDate = currentDate.format('DD/MM/YYYY');
                    const totalSeconds = dailySummarySeconds[dateKey] || 0;
                    const formattedTotal = secondsToHMS(totalSeconds);
                    const infoId = `info-${dateKey}`; 
                    const cellId = `cell-share-${dateKey}`;
                    
                    const tr = document.createElement('tr');
                    let totalCellHtml = `<td class="font-mono text-slate-700 font-bold">${formattedTotal}</td>`;
                    let inputHtml = `<input type="number" class="input-currency" placeholder="0" oninput="handleDailyInput('${dateKey}', this.value)">`;
                    let shareHtml = `<div class="text-right text-xs font-bold text-blue-600" id="${infoId}">Rp 0</div>`;

                    if (totalSeconds === 0) {
                        tr.style.backgroundColor = '#fffbeb'; // Amber background for holidays
                        totalCellHtml = `<td class="italic text-xs text-amber-600">Non-Operasional / Libur</td>`;
                        
                        shareHtml = `
                            <div id="alloc-wrapper-${dateKey}" style="display:none;" class="ms-wrapper">
                                <div class="ms-display" id="ms-disp-${dateKey}" onclick="toggleMs(event, '${dateKey}')">-- Pilih Tujuan Alokasi --</div>
                                <div class="ms-summary" id="ms-sum-${dateKey}"></div>
                                <div class="text-right text-xs font-bold text-blue-600" id="${infoId}">Rp 0</div>
                            </div>
                            <div id="alloc-placeholder-${dateKey}" class="text-xs text-slate-400 text-right">-</div>
                        `;
                    }

                    tr.innerHTML = `<td class="font-medium text-slate-600">${displayDate}</td>${totalCellHtml}<td>${inputHtml}</td><td id="${cellId}">${shareHtml}</td>`;
                    tbodyDaily.appendChild(tr);
                    currentDate.add(1, 'days');
                }
            }
            
            // Close dropdowns
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.ms-wrapper') && !event.target.closest('.ms-dropdown')) {
                    document.querySelectorAll('.ms-dropdown').forEach(d => d.classList.remove('show'));
                }
            });
            
            updateCalculations();
        }

        // --- 4. MULTI SELECT LOGIC (FIXED POSITION) ---
        function generateMultiSelectOptions(dateKey) {
            let html = '';
            const options = [
                {val: 'KAS', label: 'KAS CADANGAN'},
                {val: 'PRODI', label: 'SETORAN PRODI'},
                {val: 'MAHASISWA', label: 'BAGI HASIL MERATA (SEMUA SDM)'},
            ];
            
            options.forEach(opt => {
                html += `<label class="ms-option"><input type="checkbox" value="${opt.val}" onchange="handleMsChange('${dateKey}', this)"> ${opt.label}</label>`;
            });
            
            html += `<div style="padding:4px 8px; background:#f1f5f9; font-size:0.65rem; font-weight:bold; color:#64748b; margin-top:4px;">PEGAWAI SPESIFIK:</div>`;
            uniqueEmployeeList.forEach(name => {
                html += `<label class="ms-option"><input type="checkbox" value="${name}" onchange="handleMsChange('${dateKey}', this)"> ${name}</label>`;
            });
            return html;
        }

        window.toggleMs = function(event, dateKey) {
            event.stopPropagation();
            // Remove existing dropdowns first
            document.querySelectorAll('.ms-dropdown').forEach(d => d.remove());
            document.querySelectorAll('.ms-dropdown').forEach(d => d.classList.remove('show'));

            // Create new dropdown dynamically attached to body to avoid overflow hidden issues
            const existingDrop = document.getElementById(`ms-drop-${dateKey}`);
            if(existingDrop) {
                existingDrop.remove();
                return; 
            }

            const wrapper = document.getElementById(`alloc-wrapper-${dateKey}`);
            const rect = wrapper.getBoundingClientRect();

            const drop = document.createElement('div');
            drop.id = `ms-drop-${dateKey}`;
            drop.className = 'ms-dropdown show custom-scroll';
            drop.innerHTML = generateMultiSelectOptions(dateKey);
            
            // Position it
            drop.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            drop.style.left = rect.left + 'px';
            drop.style.width = Math.max(rect.width, 250) + 'px'; // At least wrapper width
            
            // Re-check checkboxes based on state
            const currentAlloc = specialAllocations[dateKey] || [];
            drop.querySelectorAll('input').forEach(inp => {
                if(currentAlloc.includes(inp.value)) inp.checked = true;
            });

            document.body.appendChild(drop);
        };

        window.handleMsChange = function(dateKey, checkbox) {
            if (!specialAllocations[dateKey]) specialAllocations[dateKey] = [];
            
            if (checkbox.checked) {
                if (!specialAllocations[dateKey].includes(checkbox.value)) specialAllocations[dateKey].push(checkbox.value);
            } else {
                specialAllocations[dateKey] = specialAllocations[dateKey].filter(item => item !== checkbox.value);
            }

            // Update Display Text
            const disp = document.getElementById(`ms-disp-${dateKey}`);
            const count = specialAllocations[dateKey].length;
            
            if (count === 0) {
                disp.innerText = "-- Pilih Tujuan Alokasi --";
                disp.classList.remove('active');
            } else {
                disp.innerText = `${count} Tujuan Dipilih`;
                disp.classList.add('active');
            }
            
            updateCalculations();
        };

        // --- 5. INPUT HANDLING ---
        window.handleDailyInput = function(dateKey, val) {
            tableInputs[dateKey] = parseFloat(val) || 0;
            
            const totalDailySeconds = dailySummarySeconds[dateKey] || 0;
            const portionMahasiswa = tableInputs[dateKey] * 0.40;
            
            const infoSpan = document.getElementById(`info-${dateKey}`);
            if(infoSpan) infoSpan.innerText = formatRupiah(portionMahasiswa);

            if (totalDailySeconds === 0) {
                const wrapper = document.getElementById(`alloc-wrapper-${dateKey}`);
                const placeholder = document.getElementById(`alloc-placeholder-${dateKey}`);
                if (wrapper && placeholder) {
                    if (tableInputs[dateKey] > 0) {
                        wrapper.style.display = 'block';
                        placeholder.style.display = 'none';
                    } else {
                        wrapper.style.display = 'none';
                        placeholder.style.display = 'block';
                        // Reset logic
                        if (specialAllocations[dateKey]) {
                            specialAllocations[dateKey] = [];
                            const disp = document.getElementById(`ms-disp-${dateKey}`);
                            if(disp) { disp.innerText = "-- Pilih Tujuan Alokasi --"; disp.classList.remove('active'); }
                        }
                    }
                }
            } 
            updateCalculations();
        };

        globalProfitInput.addEventListener('input', (e) => {
            currentGlobalProfit = parseFloat(e.target.value) || 0;
            updateCalculations();
        });

        // --- 6. CORE CALCULATION LOGIC ---
        function updateCalculations() {
            let displayMhs = currentGlobalProfit * 0.40;
            let displayKas = currentGlobalProfit * 0.20;
            let displayProdi = currentGlobalProfit * 0.40;

            let bonusPoolMhs = 0; 
            let totalInputRaw = 0;
            let totalNoWorkProfit = 0;
            let totalNoWorkAllocated = 0;

            const empTempTotals = {};
            uniqueEmployeeList.forEach(n => empTempTotals[n] = 0);

            for (const [dateKey, profit] of Object.entries(tableInputs)) {
                if (profit <= 0) continue;
                
                totalInputRaw += profit;
                const portion40 = profit * 0.40;
                const totalSec = dailySummarySeconds[dateKey] || 0;

                if (totalSec > 0) {
                    // Absensi Normal
                    const detailRows = document.querySelectorAll(`#tableHardfile tr[data-date-key="${dateKey}"]`);
                    detailRows.forEach(row => {
                        const userSec = parseFloat(row.getAttribute('data-seconds'));
                        const share = (userSec / totalSec) * portion40;
                        const cell = row.querySelector('.incentive-cell');
                        if(cell) {
                            cell.innerText = formatRupiah(share);
                            cell.className = "incentive-cell text-right font-bold text-green-600";
                        }
                        const name = row.children[0].innerText;
                        if(empTempTotals[name] !== undefined) empTempTotals[name] += share;
                    });

                } else {
                    // SPLIT ALLOCATION
                    totalNoWorkProfit += profit;
                    totalNoWorkAllocated += portion40;

                    const targets = specialAllocations[dateKey] || [];
                    const targetCount = targets.length;

                    const summaryDiv = document.getElementById(`ms-sum-${dateKey}`);
                    if (summaryDiv) {
                        if (targetCount > 0) summaryDiv.innerText = `(${formatRupiah(portion40/targetCount)} / opsi)`;
                        else summaryDiv.innerText = "";
                    }

                    if (targetCount > 0) {
                        const splitAmount = portion40 / targetCount;
                        targets.forEach(target => {
                            if (target === 'KAS') {
                                displayMhs -= splitAmount;
                                displayKas += splitAmount;
                            } else if (target === 'PRODI') {
                                displayMhs -= splitAmount;
                                displayProdi += splitAmount;
                            } else if (target === 'MAHASISWA') {
                                bonusPoolMhs += splitAmount; 
                            } else if (target && uniqueEmployeeList.includes(target)) {
                                if(empTempTotals[target] !== undefined) empTempTotals[target] += splitAmount;
                            }
                        });
                    }
                }
            }

            // Equal Split Pool
            if (bonusPoolMhs > 0 && uniqueEmployeeList.length > 0) {
                const equalShare = bonusPoolMhs / uniqueEmployeeList.length; 
                uniqueEmployeeList.forEach(name => {
                    empTempTotals[name] += equalShare;
                });
            }

            // UI Updates
            cardValMhs.innerText = formatRupiah(displayMhs);
            cardValKas.innerText = formatRupiah(displayKas);
            cardValProdi.innerText = formatRupiah(displayProdi);
            document.getElementById('totalInputLaba').innerText = formatRupiah(totalInputRaw);
            
            let totalDistributedToPeople = 0;
            for (let key in empTempTotals) totalDistributedToPeople += empTempTotals[key];
            
            document.getElementById('summaryAllocatedMhs').innerText = "Total Terdistribusi: " + formatRupiah(totalDistributedToPeople); 
            document.getElementById('summaryNoWorkProfit').innerText = formatRupiah(totalNoWorkProfit);
            document.getElementById('summaryNoWorkAllocated').innerText = formatRupiah(totalNoWorkAllocated);

            // Status Box
            const statusBox = document.getElementById('statusBox');
            let pendingAllocation = false;
            for (const [dk, profit] of Object.entries(tableInputs)) {
                if (profit > 0 && (!dailySummarySeconds[dk] || dailySummarySeconds[dk] === 0)) {
                    if (!specialAllocations[dk] || specialAllocations[dk].length === 0) pendingAllocation = true;
                }
            }

            if (currentGlobalProfit === 0 && totalInputRaw === 0) {
                statusBox.innerText = "MENUNGGU DATA INPUT";
                statusBox.className = 'status-badge st-ok';
            } else {
                const diff = totalDistributedToPeople - displayMhs;
                // Toleransi floating point kecil
                if (Math.abs(diff) > 500) { 
                    if (diff < 0) {
                        statusBox.innerText = `KURANG (BELUM TERBAGI): ${formatRupiah(Math.abs(diff))} ❌`;
                        statusBox.className = 'status-badge st-err';
                    } else {
                        statusBox.innerText = `LEBIH (OVER): +${formatRupiah(diff)} ⚠️`;
                        statusBox.className = 'status-badge st-warn';
                    }
                } else {
                    if (pendingAllocation) {
                        statusBox.innerText = "PILIH TUJUAN ALOKASI DI TABEL HARIAN ⚠️";
                        statusBox.className = 'status-badge st-warn';
                    } else {
                        statusBox.innerText = "REKONSILIASI SEIMBANG (BALANCE) ✅";
                        statusBox.className = 'status-badge st-ok';
                    }
                }
            }

            renderEmployeeCards(empTempTotals, bonusPoolMhs);
        }

        // --- 7. RENDER CARDS ---
        function renderEmployeeCards(empTotals, bonusPool) {
            employeeCardsContainer.innerHTML = '';
            const empDetails = {};
            
            globalExcelData.forEach(row => {
                const name = row['Nama'] || row['nama'];
                if(!empDetails[name]) empDetails[name] = [];
                empDetails[name].push(row);
            });

            uniqueEmployeeList.forEach(name => {
                const totalGaji = empTotals[name] || 0;
                const details = empDetails[name] || [];

                const card = document.createElement('div');
                card.className = 'emp-section';

                let tableHtml = `
                    <div class="emp-head">
                        <span class="emp-name"><i class="fa-solid fa-user text-slate-400"></i> ${name}</span>
                        <span class="emp-total">${formatRupiah(totalGaji)}</span>
                    </div>
                    <table class="w-full">
                        <thead class="bg-slate-50 text-xs text-slate-500 border-b">
                            <tr>
                                <th class="p-2 text-left w-1/5">TGL</th>
                                <th class="p-2 text-left w-1/5">JAM</th>
                                <th class="p-2 text-left w-2/5">SUMBER</th>
                                <th class="p-2 text-right w-1/5">RP</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // 1. Absensi
                details.forEach(row => {
                    const dateKey = row._normalizedDateKey;
                    const totalSec = dailySummarySeconds[dateKey] || 0;
                    const profit = tableInputs[dateKey] || 0;
                    
                    if (totalSec > 0 && profit > 0) {
                        const userSec = timeStringToSeconds(row['Total Jam Kerja']);
                        const share = (userSec / totalSec) * (profit * 0.40);
                        
                        tableHtml += `
                            <tr>
                                <td class="p-2 border-b text-xs">${row._displayDate}</td>
                                <td class="p-2 border-b text-xs">${row['Total Jam Kerja']}</td>
                                <td class="p-2 border-b text-xs text-slate-500">Insentif Kerja</td>
                                <td class="p-2 border-b text-xs text-right font-medium text-slate-700">${formatRupiah(share)}</td>
                            </tr>
                        `;
                    }
                });

                // 2. Alokasi Manual
                for (const [dateKey, targets] of Object.entries(specialAllocations)) {
                    if (!targets || targets.length === 0) continue;

                    const profit = tableInputs[dateKey] || 0;
                    const portion40 = profit * 0.40;
                    const splitAmount = portion40 / targets.length;
                    const displayDate = moment(dateKey).format('DD/MM/YYYY');

                    // Nama Spesifik
                    if (targets.includes(name)) {
                        tableHtml += `
                            <tr class="bg-orange-50">
                                <td class="p-2 border-b text-xs">${displayDate}</td>
                                <td class="p-2 border-b text-xs">-</td>
                                <td class="p-2 border-b text-xs text-orange-700 font-bold">Insentif Khusus</td>
                                <td class="p-2 border-b text-xs text-right font-bold text-orange-700">${formatRupiah(splitAmount)}</td>
                            </tr>
                        `;
                    }

                    // Bagi Rata
                    if (targets.includes('MAHASISWA')) {
                        const sharePerPerson = splitAmount / uniqueEmployeeList.length;
                        tableHtml += `
                            <tr class="bg-green-50">
                                <td class="p-2 border-b text-xs">${displayDate}</td>
                                <td class="p-2 border-b text-xs">-</td>
                                <td class="p-2 border-b text-xs text-green-700 font-bold">Bagi Hasil Merata</td>
                                <td class="p-2 border-b text-xs text-right font-bold text-green-700">${formatRupiah(sharePerPerson)}</td>
                            </tr>
                        `;
                    }
                }

                tableHtml += `</tbody></table>`;
                card.innerHTML = tableHtml;
                employeeCardsContainer.appendChild(card);
            });
        }

        // --- 8. EXPORT EXCEL ---
        function exportToExcel() {
            if (!dateRange.min) { alert("Tidak ada data untuk diexport!"); return; }

            const wb = XLSX.utils.book_new();

            // Hitung Ulang untuk Finalisasi
            let finalCardMhs = currentGlobalProfit * 0.40;
            let finalCardKas = currentGlobalProfit * 0.20;
            let finalCardProdi = currentGlobalProfit * 0.40;
            let totalInput = 0;
            
            const empFinalTotals = {};
            uniqueEmployeeList.forEach(n => empFinalTotals[n] = 0);

            for (const [dateKey, profit] of Object.entries(tableInputs)) {
                if(profit <= 0) continue;
                totalInput += profit;
                const p40 = profit * 0.40;
                const totalSec = dailySummarySeconds[dateKey] || 0;

                if (totalSec > 0) {
                    const detailRows = document.querySelectorAll(`#tableHardfile tr[data-date-key="${dateKey}"]`);
                    detailRows.forEach(row => {
                        const userSec = parseFloat(row.getAttribute('data-seconds'));
                        const share = (userSec / totalSec) * p40;
                        const name = row.children[0].innerText;
                        empFinalTotals[name] += share;
                    });
                } else {
                    const targets = specialAllocations[dateKey] || [];
                    if (targets.length > 0) {
                        const splitAmount = p40 / targets.length;
                        targets.forEach(target => {
                                if (target === 'KAS') {
                                    finalCardMhs -= splitAmount;
                                    finalCardKas += splitAmount;
                                } else if (target === 'PRODI') {
                                    finalCardMhs -= splitAmount;
                                    finalCardProdi += splitAmount;
                                } else if (target === 'MAHASISWA') {
                                    const perPerson = splitAmount / uniqueEmployeeList.length;
                                    uniqueEmployeeList.forEach(n => empFinalTotals[n] += perPerson);
                                } else if (target && uniqueEmployeeList.includes(target)) {
                                    empFinalTotals[target] += splitAmount;
                                }
                        });
                    }
                }
            }

            // SHEET 1: RINGKASAN
            const summaryData = [
                ["LAPORAN DISTRIBUSI PROFIT"], [""],
                ["POSISI KEUANGAN AKHIR"],
                ["Total Laba Bersih (Net Profit)", currentGlobalProfit],
                ["Saldo Akhir Dana SDM", finalCardMhs],
                ["Saldo Akhir Kas Cadangan", finalCardKas],
                ["Saldo Akhir Setoran Prodi", finalCardProdi],
                [""],
                ["REALISASI HARIAN"],
                ["Total Revenue Harian Tercatat", totalInput]
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), "Ringkasan Eksekutif");

            // SHEET 2: DATA INPUT
            const cleanRawData = globalExcelData.map(row => {
                const cleanRow = {...row};
                delete cleanRow._normalizedDateKey;
                delete cleanRow._displayDate;
                delete cleanRow.__rowNum__;
                return cleanRow;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cleanRawData), "Input Absensi");

            // SHEET 3: JURNAL
            const sheetDaily = [["TANGGAL", "DURASI OPS", "REVENUE HARIAN", "ALOKASI SDM (40%)", "STATUS / ALOKASI"]];
            let curr = dateRange.min.clone();
            const end = dateRange.max.clone();
            while(curr.isSameOrBefore(end)){
                const dk = curr.format('YYYY-MM-DD');
                const sec = dailySummarySeconds[dk]||0;
                const prof = tableInputs[dk]||0;
                let status = (sec===0) ? "LIBUR / NON-OPS" : "OPERASIONAL";
                
                if (sec === 0 && prof > 0) {
                    const targets = specialAllocations[dk] || [];
                    if(targets.length > 0) status = `RE-ALOKASI KE: ${targets.join(', ')}`;
                    else status = "PENDING ALOKASI";
                }

                sheetDaily.push([curr.format('DD/MM/YYYY'), secondsToHMS(sec), prof, prof*0.40, status]);
                curr.add(1, 'days');
            }
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheetDaily), "Jurnal Harian");

            // SHEET 4: RINCIAN
            const sheetDet = [["NAMA SDM", "TANGGAL", "JENIS TRANSAKSI", "JAM KERJA", "NOMINAL"]];
            // Absensi
            globalExcelData.forEach(row => {
                const dk = row._normalizedDateKey;
                const sec = dailySummarySeconds[dk]||0;
                const prof = tableInputs[dk]||0;
                if(sec > 0 && prof > 0) {
                    const uSec = timeStringToSeconds(row['Total Jam Kerja']);
                    const share = (uSec/sec)*(prof*0.40);
                    sheetDet.push([row['Nama'] || row['nama'], row._displayDate, "INSENTIF ABSENSI", row['Total Jam Kerja'], share]);
                }
            });
            // Alokasi Manual
            for (const [dk, targets] of Object.entries(specialAllocations)) {
                const prof = tableInputs[dk]||0;
                const portion40 = prof*0.40;
                if(targets.length > 0){
                    const split = portion40 / targets.length;
                    const displayDate = moment(dk).format('DD/MM/YYYY');
                    targets.forEach(t => {
                        if (t === 'MAHASISWA') {
                            const perPerson = split / uniqueEmployeeList.length;
                            uniqueEmployeeList.forEach(name => {
                                sheetDet.push([name, displayDate, "BAGI HASIL MERATA", "-", perPerson]);
                            });
                        } else if (t && uniqueEmployeeList.includes(t)) {
                            sheetDet.push([t, displayDate, "INSENTIF KHUSUS", "-", split]);
                        }
                    });
                }
            }
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheetDet), "Rincian Transaksi SDM");

            // SHEET 5: REKAP
            const sheetTotal = [["NAMA SDM", "TOTAL TAKE HOME PAY"]];
            Object.keys(empFinalTotals).sort().forEach(n => {
                sheetTotal.push([n, empFinalTotals[n]]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheetTotal), "Rekap Gaji Akhir");

            XLSX.writeFile(wb, "LAPORAN_DISTRIBUSI_" + uploadedFileName + ".xlsx");
        }
    </script>
</body>
</html>